{% extends "base.html" %}
{% load static %}
{% block style %}
    <link href="{% static 'fontawesomefree/css/fontawesome.css' %}"
          rel="stylesheet"
          type="text/css">
    <link href="{% static 'fontawesomefree/css/brands.css' %}"
          rel="stylesheet"
          type="text/css">
    <link href="{% static 'fontawesomefree/css/solid.css' %}"
          rel="stylesheet"
          type="text/css">
{% endblock style %}
{% block content %}
    <div class="mx-auto max-w-5xl flex h-full">
        <div class="flex-auto pr-8">
            <div class="pt-20">
                <div class="flex justify-between">
                    <form method="get" class="flex flex-auto justify-between pr-10">
                        <div class="flex flex-col flex-auto">
                            <h2 class="text-2xl text-neutral-500">스터디 검색</h2>
                            <label class="mt-2 p-2 px-4 rounded-full border border-neutral-600 cursor-text">
                                <i class="fa-solid fa-magnifying-glass"></i>
                                <input type="text"
                                       name="query"
                                       maxlength="100"
                                       id="id_query"
                                       placeholder="키워드를 입력해주세요."
                                       class="pl-2 bg-transparent outline-none placeholder-black">
                            </label>
                        </div>
                        <div class="flex flex-col flex-auto pl-8">
                            <h2 class="text-2xl text-neutral-500">테그 필터</h2>
                            <label class="mt-2 p-2 px-4 rounded-full border border-neutral-600 cursor-text">
                                <i class="fa-regular fa-tag"></i>
                                <input type="text"
                                       name="tag"
                                       maxlength="100"
                                       id="id_tag"
                                       {% if tag %}value="{{ tag }}"{% endif %}
                                       placeholder="테그를 입력해주세요."
                                       class="pl-2 bg-transparent outline-none placeholder-black">
                            </label>
                        </div>
                        <button type="submit" hidden>검색</button>
                    </form>
                    <div>
                        <a href="{% url 'recruits:create_recruit' %}">
                            <div class="p-2 border-2 border-neutral-600">
                                <i class="fa-solid fa-plus fa-xl"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            <ul id="recruit-list"
                class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 {% if user.is_authenticated %}grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3{% endif %} gap-8 pt-8">
                {% for recruit in recruits %}
                    <li>
                        <div class="shadow-md rounded-xl p-3">
                            <a href="{% url 'recruits:recruit_detail' recruit.id %}">
                                <div class="w-full pt-4">
                                    <h3 class="text-xl">{{ recruit.title }}</h3>
                                    <p class="pt-1">{{ recruit.creator }}</p>
                                </div>
                                <div class="flex justify-between pt-2">
                                    <span class="text-neutral-500">{{ recruit.deadline|date:'Y.m.d' }}</span>
                                    <span>{{ recruit.members.count }}/{{ recruit.total_seats }}</span>
                                </div>
                            </a>
                            <ul class="flex pt-1 flex-wrap">
                                {% for tag in recruit.tags.all %}
                                    <li class="mr-2 mb-2 last:m-0">
                                        <a href="?tag={{ tag.name }}" class="bg-neutral-200 rounded-full px-2">{{ tag.name }}</a>
                                    </li>
                                {% endfor %}
                            </ul>
                            <div class="pt-1">
                                <span>{{ recruit.like_users.count }}</span>
                                {% if recruit in liked_studies %}
                                    <a href="{% url 'recruits:unlike_recruit' recruit.pk %}">
                                        <i class="fa-solid fa-heart text-red-400"></i>
                                    </a>
                                {% else %}
                                    <a href="{% url 'recruits:like_recruit' recruit.pk %}">
                                        <i class="fa-solid fa-heart"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% if user.is_authenticated %}
            <div id="sidebar"
                 class="flex-none w-64 border-l border-r border-neutral-300 overflow-y-auto">
                <div class="pt-20 px-4">
                    {% if in_studies %}
                        <div class="pb-8">
                            <h3 class="text-xl font-bold pb-2">참여 중인 스터디</h3>
                            <ul class="p-2 bg-neutral-100 rounded-md">
                                {% for study in in_studies %}
                                    <a href="{% url 'manager:study_detail' study.id %}">
                                        <li class="border-b border-neutral-600 last:border-none">{{ study.study.title }}</li>
                                    </a>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    {% if liked_studies %}
                        <div>
                            <h3 class="text-xl font-bold pb-2">좋아요 누른 스터디</h3>
                            <ul class="p-2 bg-neutral-100 rounded-md">
                                {% for recruit in liked_studies %}
                                    <a href="{% url 'recruits:recruit_detail' recruit.id %}">
                                        <li class="border-b border-neutral-600 last:border-none">{{ recruit.title }}</li>
                                    </a>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock content %}
{% block script %}
    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
            let page = 1;
            let emptyPage = false;
            let blockRequest = false;
            let lastScrollY = 0;

            window.addEventListener('scroll', function (e) {
                let currentScrollY = window.scrollY;
                let margin = document.body.clientHeight - window.innerHeight - 200;

                if (currentScrollY > lastScrollY && currentScrollY > margin && !emptyPage && !blockRequest) {
                    blockRequest = true;
                    page += 1;
                    fetch('?page=' + page)
                        .then(response => response.text())
                        .then(html => {
                            let parser = new DOMParser();
                            let doc = parser.parseFromString(html, 'text/html');
                            let recruitContent = doc.getElementById("recruit-list").innerHTML;

                            if (recruitContent === '') {
                                emptyPage = true;
                            } else {
                                let recruitList = document.getElementById("recruit-list");
                                recruitList.insertAdjacentHTML('beforeend', recruitContent);
                                blockRequest = false;
                            }
                        });
                }
                lastScrollY = currentScrollY;
            });
            let scrollEvent = new Event('scroll');
            window.dispatchEvent(scrollEvent);
        })
    </script>
{% endblock script %}
