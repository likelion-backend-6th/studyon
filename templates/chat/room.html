{% extends "base.html" %}
{% block title %}
    Chat room for "{{ study.title }}"
{% endblock title %}
{% block content %}
    <div id="chat">
        {% for chat in chats %}
            <div>
                <strong>
                    {% if chat.creator == request.user %}
                        Me
                    {% else %}
                        {{ chat.creator }}
                    {% endif %}
                </strong>
                <br>
                {{ chat.content }}
            </div>
        {% endfor %}
    </div>
    <div id="chat-input">
        <input id="chat-message-input" type="text">
        <input id="chat-message-submit" type="submit" value="Send">
    </div>
{% endblock content %}
{% block include_js %}
    {{ study.id|json_script:"study-id" }}
    {{ request.user.username|json_script:"request-user" }}
    {{ request.POST|json_script:"tags" }}
{% endblock include_js %}
{% block script %}
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const studyId = JSON.parse(
                document.getElementById('study-id').textContent
            );
            const requestUser = JSON.parse(
                document.getElementById('request-user').textContent
            );
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const url = protocol + window.location.host + '/chat/ws/chat/room/' + studyId + '/';

            const handlers = {
                ws: null,
                retry: 0,

                connect(ws_url) {
                    this.ws = new WebSocket(ws_url || this.ws?.url);

                    this.ws.onopen = this.onopen.bind(this);
                    this.ws.onclose = this.onclose.bind(this);
                    this.ws.onerror = this.onerror.bind(this);
                    this.ws.onmessage = this.onmessage.bind(this);
                },

                reconnect() {
                    this.connect();
                },

                onopen() { 
                    console.log("Chat socket opened");
                    this.retry = 0;
                },

                onclose(event) {
                    if(!event.wasClean) {
                        console.error("Chat socket closed unexpectedly");

                        if (this.retry < 3) {
                            setTimeout(() => {
                                this.retry += 1;
                                this.reconnect();
                                console.log(`[${this.retry}] retry to connect ...`);
                            }, 1000 * this.retry);
                        } else {
                            alert("Can't connect to Server. Move to Study Manage Page.");
                            window.location.href = `/studies/${studyId}`;
                        }
                    }
                },

                onerror() { console.error("Error occurred"); },

                onmessage(event) {
                    console.log(event)
                    const data = JSON.parse(event.data);
                    const chat = document.getElementById('chat');
                    const isMe = data.user === requestUser;
                    const source = isMe ? 'me' : 'other';
                    const name = isMe ? 'Me' : data.user;
                    chat.innerHTML += '<div class="message ' + source + '">'
                        + '<strong>' + name + '</strong><br>'
                        + data.message + '</div>';
                    chat.scrollTop = chat.scrollHeight;
                },

            };

            handlers.connect(url);

            const input = document.getElementById('chat-message-input');
            const submitButton = document.getElementById('chat-message-submit');
            submitButton.addEventListener('click', function (event) {
                const message = input.value;
                if (message) {
                    chatSocket.send(JSON.stringify({'message': message}));
                    input.value = '';
                    input.focus();
                }
            });
            input.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    submitButton.click();
                }
            });
        })
    </script>
{% endblock script %}
